<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style2.css" />
    <title>ƒê·ªçc th·ª≠</title>
</head>

<body>
    <div class="book-container">
        <!-- Flipbook -->
        <div id="flipbook" class="flipbook"></div>

        <!-- Thanh ƒëi·ªÅu khi·ªÉn -->
        <div class="book-controls">
            <span>Trang: <span id="current-page">1</span>/<span id="total-pages">0</span></span>

            <div class="goto-box">
                <input type="number" id="goto-page" min="1" placeholder="Nh·∫≠p s·ªë trang..." />
                <button id="btn-goto">T·ªõi trang</button>
                <a href="index1.html">
                    <button id="btn-goto">V·ªÅ trang ch·ªß</button>
                </a>

            </div>

            <!-- N√∫t nghe s√°ch n√≥i -->
            <button id="btn-audio">‚ñ∂ Nghe s√°ch n√≥i</button>
        </div>
    </div>

    <!-- √ÇM THANH L·∫¨T S√ÅCH -->
    <audio id="flip-sound" src="flip.mp3" preload="auto"></audio>

    <!-- √ÇM THANH S√ÅCH N√ìI (s·∫Ω g√°n src b·∫±ng JS theo t·ª´ng s√°ch) -->
    <audio id="book-audio" preload="auto"></audio>

    <!-- jQuery v√† Turn.js -->
    <script src="jquery.js"></script>
    <script src="turn.js"></script>

    <!-- PDF.js t·ª´ CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // C·∫•u h√¨nh worker c·ªßa PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

        // ===============================
        //   DANH S√ÅCH S√ÅCH (PDF + AUDIO)
        //   -> ch·ªânh file s√°ch n√≥i, PDF ·ªü ƒë√¢y
        // ===============================
        const books = [
            {
                id: 1,
                title: "D√°m B·ªã Gh√©t",
                author: "Ichiro Kishimi & Fumitake Koga",
                pdf: "pdf/1.pdf",
                audio: "audio/1.mp3",
            },
            {
                id: 2,
                title: "ƒê·∫Øc Nh√¢n T√¢m",
                author: "Dale Carnegie",
                pdf: "pdf/2.pdf",
                audio: "audio/2.mp3",
            },
            {
                id: 3,
                title: "Nh√† Gi·∫£ Kim",
                author: "Paulo Coelho",
                pdf: "pdf/3.pdf",
                audio: "audio/3.mp3",
            },
            {
                id: 4,
                title: "Tu·ªïi Tr·∫ª ƒê√°ng Gi√° Bao Nhi√™u",
                author: "Rosie Nguy·ªÖn",
                pdf: "pdf/4.pdf",
                audio: "audio/4.mp3",
            },
            {
                id: 5,
                title: "Khi h∆°i th·ªü ho√° thinh kh√¥ng",
                author: "Paul Kalanithi",
                pdf: "pdf/5.pdf",
                audio: "audio/5.mp3",
            },
            {
                id: 6,
                title: "T√¥i th·∫•y hoa v√†ng tr√™n c·ªè xanh",
                author: "Nguy·ªÖn Nh·∫≠t √Ånh",
                pdf: "pdf/6.pdf",
                audio: "audio/6.mp3",
            },
            {
                id: 7,
                title: "M·∫Øt bi·∫øc",
                author: "Nguy·ªÖn Nh·∫≠t √Ånh",
                pdf: "pdf/7.pdf",          // üëà file PDF demo b·∫°n ƒëang d√πng c√≥ th·ªÉ ƒë·ªïi th√†nh sach-demo.pdf
                audio: "audio/7.mp3",     // üëà file s√°ch n√≥i t∆∞∆°ng ·ª©ng
            },
            {
                id: 8,
                title: "C√¥ g√°i ƒë·∫øn t·ª´ h√¥m qua",
                author: "Nguy·ªÖn Nh·∫≠t √Ånh",
                pdf: "pdf/8.pdf",
                audio: "audio/8.mp3",
            },
            {
                id: 9,
                title: "S·ªëng xanh kh√¥ng kh√≥",
                author: "Nam Kha",
                pdf: "pdf/9.pdf",
                audio: "audio/9.mp3",
            },
            {
                id: 10,
                title: "Ni√™n l·ªãch mi·ªÅn gi√≥ c√°t",
                author: "Aldo Leopold",
                pdf: "pdf/10.pdf",
                audio: "audio/10.mp3",
            },
            {
                id: 11,
                title: "ƒê·ªùi th·ª´a",
                author: "Nam Cao",
                pdf: "pdf/11.pdf",
                audio: "audio/11.mp3",
            },
            {
                id: 12,
                title: "T·ªôi √°c v√† tr·ª´ng ph·∫°t",
                author: "Fyodor M. Dostoyevsky",
                pdf: "pdf/12.pdf",
                audio: "audio/12.mp3",
            },
        ];

        // ===============================
        //   CH·ªåN S√ÅCH THEO ?id= TR√äN URL
        // ===============================
        function getBookFromQuery() {
            const params = new URLSearchParams(window.location.search);
            const idParam = params.get("id");
            const idNum = Number(idParam);

            let found = books.find(b => b.id === idNum);
            if (!found) {
                // N·∫øu kh√¥ng c√≥ id ho·∫∑c id sai -> l·∫•y s√°ch ƒë·∫ßu ti√™n
                found = books[0];
            }
            return found;
        }

        const currentBook = getBookFromQuery();
        const pdfUrl = currentBook.pdf;   // üëà d√πng pdf c·ªßa s√°ch hi·ªán t·∫°i

        const $flipbook = $("#flipbook");
        let pdfTotalPages = 0;

        // L·∫•y element √¢m thanh
        const flipSound = document.getElementById("flip-sound");
        const bookAudio = document.getElementById("book-audio");
        const btnAudio = document.getElementById("btn-audio");
        let isBookAudioPlaying = false;

        // G√°n file s√°ch n√≥i cho audio (n·∫øu c√≥)
        if (currentBook.audio && bookAudio) {
            bookAudio.src = currentBook.audio;
        }

        function playFlipSound() {
            if (!flipSound) return;
            try {
                flipSound.currentTime = 0;
                flipSound.play().catch(() => { });
            } catch (e) {
                console.warn("Kh√¥ng ph√°t ƒë∆∞·ª£c √¢m thanh flip:", e);
            }
        }

        function updateAudioButton() {
            if (!btnAudio) return;
            btnAudio.textContent = isBookAudioPlaying ? "‚è∏ D·ª´ng s√°ch n√≥i" : "‚ñ∂ Nghe s√°ch n√≥i";
        }

        function toggleBookAudio() {
            if (!bookAudio) return;
            if (!bookAudio.src) return; // s√°ch n√†y ch∆∞a c√≥ audio

            if (bookAudio.paused) {
                bookAudio.play().then(() => {
                    isBookAudioPlaying = true;
                    updateAudioButton();
                }).catch(err => {
                    console.warn("Kh√¥ng ph√°t ƒë∆∞·ª£c s√°ch n√≥i:", err);
                });
            } else {
                bookAudio.pause();
                isBookAudioPlaying = false;
                updateAudioButton();
            }
        }

        if (btnAudio && bookAudio) {
            btnAudio.addEventListener("click", toggleBookAudio);
            bookAudio.addEventListener("ended", () => {
                isBookAudioPlaying = false;
                updateAudioButton();
            });
        }

        // T√≠nh k√≠ch th∆∞·ªõc s√°ch theo m√†n h√¨nh (∆∞u ti√™n cho ƒëi·ªán tho·∫°i n·∫±m ngang)
        function getBookSize() {
            const RATIO = 1000 / 600;

            let availW = window.innerWidth * 0.98;
            let availH = window.innerHeight * 0.9;

            let width = availW;
            let height = width / RATIO;

            if (height > availH) {
                height = availH;
                width = height * RATIO;
            }

            return {
                width: Math.round(width),
                height: Math.round(height),
            };
        }

        function updateCurrentPage(turnPage) {
            if (!pdfTotalPages) return;

            let pdfPage;
            if (turnPage <= 2) {
                pdfPage = 1;
            } else if (turnPage >= pdfTotalPages + 3) {
                pdfPage = pdfTotalPages;
            } else {
                pdfPage = turnPage - 2;
            }

            document.getElementById("current-page").textContent = pdfPage;
        }

        // Kh·ªüi t·∫°o flipbook
        function initFlipbook() {
            const size = getBookSize();

            if ($flipbook.data("initialized")) {
                $flipbook.turn("size", size.width, size.height);
                return;
            }

            $flipbook.turn({
                width: size.width,
                height: size.height,
                autoCenter: true,
                elevation: 50,
                gradients: true,
                display: "double",
                page: 3,
            });

            $flipbook.bind("turning", function () {
                playFlipSound();
            });

            $flipbook.bind("turned", function (e, page) {
                updateCurrentPage(page);
            });

            $flipbook.data("initialized", true);
            updateCurrentPage(3);

            window.addEventListener("resize", function () {
                if ($flipbook.data("initialized")) {
                    const s = getBookSize();
                    $flipbook.turn("size", s.width, s.height);
                }
            });
        }

        // T√≠nh nƒÉng "t·ªõi trang"
        function setupGoto() {
            const input = document.getElementById("goto-page");
            const btn = document.getElementById("btn-goto");

            function goToPage() {
                if (!pdfTotalPages || !$flipbook.data("initialized")) return;

                let val = parseInt(input.value, 10);
                if (isNaN(val)) return;

                if (val < 1) val = 1;
                if (val > pdfTotalPages) val = pdfTotalPages;

                const turnPage = val + 2;
                $flipbook.turn("page", turnPage);
            }

            btn.addEventListener("click", goToPage);
            input.addEventListener("keyup", function (e) {
                if (e.key === "Enter") {
                    goToPage();
                }
            });
        }

        setupGoto();

        // T·∫£i PDF
        const loadingTask = pdfjsLib.getDocument(pdfUrl);
        loadingTask.promise
            .then(function (pdf) {
                pdfTotalPages = pdf.numPages;
                document.getElementById("total-pages").textContent = pdfTotalPages;

                const totalPages = pdf.numPages;

                // B√¨a ƒë·∫ßu (d√πng title + author c·ªßa s√°ch hi·ªán t·∫°i)
                $flipbook.append(`
          <div class="hard">
            ${currentBook.title}
            <small>${currentBook.author}</small>
          </div>
        `);
                // M·∫∑t trong b√¨a
                $flipbook.append(`<div class="hard"></div>`);

                const pageDivs = [];
                for (let i = 1; i <= totalPages; i++) {
                    const pageDiv = document.createElement("div");
                    pageDiv.classList.add("page");
                    pageDiv.setAttribute("data-page", i);
                    $flipbook.append(pageDiv);
                    pageDivs[i] = pageDiv;
                }

                // B√¨a sau (th√™m lu√¥n)
                $flipbook.append(`<div class="hard"></div>`);
                $flipbook.append(`
          <div class="hard">
            H·∫øt s√°ch
            <small>~ Flipbook PDF</small>
          </div>
        `);

                // üëâ Ch·ªâ kh·ªüi ƒë·ªông flipbook sau khi render xong TRANG ƒê·∫¶U TI√äN
                let flipbookStarted = false;

                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    pdf.getPage(pageNum).then(function (page) {
                        const scale = 1.2; // gi·∫£m nh·∫π cho ƒë·ª° lag mobile
                        const viewport = page.getViewport({ scale: scale });

                        const canvas = document.createElement("canvas");
                        const context = canvas.getContext("2d");
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;

                        canvas.style.width = "100%";
                        canvas.style.height = "auto";
                        canvas.style.display = "block";

                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport,
                        };

                        page.render(renderContext).promise.then(function () {
                            const container = pageDivs[page.pageNumber];
                            if (container) {
                                container.innerHTML = "";

                                const inner = document.createElement("div");
                                inner.classList.add("page-inner");
                                inner.appendChild(canvas);

                                container.appendChild(inner);
                            }

                            // L·∫ßn ƒë·∫ßu c√≥ trang render xong -> init flipbook
                            if (!flipbookStarted) {
                                initFlipbook();
                                flipbookStarted = true;
                            }
                        }).catch(function (err) {
                            console.error("L·ªói render trang PDF:", page.pageNumber, err);
                        });
                    }).catch(function (err) {
                        console.error("L·ªói l·∫•y trang PDF:", pageNum, err);
                    });
                }
            })
            .catch(function (err) {
                console.error("L·ªói khi load PDF:", err);
                alert(
                    "Kh√¥ng t·∫£i ƒë∆∞·ª£c file PDF. H√£y ki·ªÉm tra l·∫°i t√™n file v√† ƒë∆∞·ªùng d·∫´n (pdfUrl)."
                );
            });
    </script>
</body>

</html>